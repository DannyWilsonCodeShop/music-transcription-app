// Test script for the new PDF generator format
// This creates an example PDF using the Amazing Grace template layout

const fs = require('fs');
const path = require('path');

// Import the PDF generator function (we'll simulate it here)
const { jsPDF } = require('jspdf');

// Mock data for Amazing Grace
const mockLyricsData = {
  text: `Amazing Grace, how sweet the sound
That saved a wretch like me
I once was lost, but now am found
Was blind, but now I see

'Twas grace that taught my heart to fear
And grace my fears relieved
How precious did that grace appear
The hour I first believed

Through many dangers, toils and snares
I have already come
'Tis grace hath brought me safe thus far
And grace will lead me home`
};

const mockChordsData = {
  key: 'G',
  tempo: '120',
  timeSignature: '3/4',
  chords: [
    { chord: 'G', start: 0, duration: 2 },
    { chord: 'C', start: 2, duration: 2 },
    { chord: 'G', start: 4, duration: 2 },
    { chord: 'D', start: 6, duration: 2 },
    { chord: 'G', start: 8, duration: 2 },
    { chord: 'Em', start: 10, duration: 2 },
    { chord: 'C', start: 12, duration: 2 },
    { chord: 'D', start: 14, duration: 2 }
  ]
};

// Simplified version of the PDF generator for testing
function generateExamplePDF(title, lyricsData, chordsData) {
  const doc = new jsPDF();
  
  // Header Section
  doc.setFontSize(18);
  doc.setFont('helvetica', 'bold');
  doc.text(title || 'Untitled', 20, 20); // Left-justified
  
  let yPos = 30; // Increased from 25 to 30 (added space after title)
  
  // Metadata line (Key, Tempo, Meter)
  const key = chordsData?.key || 'Unknown';
  const tempo = chordsData?.tempo || 'Unknown';
  const meter = chordsData?.timeSignature || '3/4';
  const metadataText = `Key: ${key} | Tempo: ${tempo} BPM | Meter: ${meter}`;
  
  doc.setFontSize(12);
  doc.setFont('helvetica', 'bold'); // Changed to bold
  doc.text(metadataText, 20, yPos); // Left-justified
  yPos += 13; // Increased from 10 to 13 (added 0.5 extra space before verse)
  
  // Example verse with syllable alignment
  doc.setFontSize(12);
  doc.setFont('helvetica', 'bold');
  doc.text('Verse 1', 20, yPos);
  yPos += 8; // Reduced spacing (0.5)
  
  // Generate Amazing Grace with perfect measure-based layout
  yPos = generateAmazingGraceLayout(doc, yPos);
  
  // Verse 2 - TODO: Add later once verse 1 alignment is perfect
  doc.setFontSize(12);
  doc.setFont('helvetica', 'bold');
  doc.text('Verse 2', 20, yPos);
  yPos += 8;
  
  doc.setFontSize(11);
  doc.setFont('helvetica', 'normal');
  doc.text('(Verse 2 will be added once alignment is perfected)', 20, yPos);
  
  doc.setTextColor(0, 0, 0); // Reset
  yPos += 15; // Reduced spacing (0.5)
  
  // Footer
  const pageHeight = doc.internal.pageSize.height;
  doc.setFontSize(8);
  doc.setTextColor(128, 128, 128);
  const footerText = 'Generated by Cipher - Downbeat-Aligned Nashville Number System';
  doc.text(footerText, 20, pageHeight - 10);
  
  return Buffer.from(doc.output('arraybuffer'));
}

function generateAmazingGraceLayout(doc, yPos) {
  // Perfect 4-measure layout with RED downbeats and BLACK passing chords
  // Each measure can have up to 8 passing chords between downbeats
  
  // Define tab positions for 4-measure alignment
  const tab1 = 38;   // First measure downbeat
  const tab2 = 73;   // Second measure downbeat  
  const tab3 = 108;  // Third measure downbeat
  const tab4 = 143;  // Fourth measure downbeat
  
  // Line 1: A- maz- ing Grace, how sweet the sound
  const line1Measures = [
    {
      pickup: { syllable: 'A-', position: tab1 - 9 },
      downbeat: { syllable: 'maz-', chordNumber: '1' },
      additional: [{ syllable: 'ing', offset: 12 }]
    },
    {
      downbeat: { syllable: 'Grace,', chordNumber: '1' },
      additional: [{ syllable: 'how', offset: 15 }]
    },
    {
      downbeat: { syllable: 'sweet', chordNumber: '5' },
      additional: [{ syllable: 'the', offset: 18 }],
      passingChords: [{ number: '4', position: tab3 + 18 }]
    },
    {
      downbeat: { syllable: 'sound', chordNumber: '1' }
    }
  ];
  
  yPos = generateMeasureLine(doc, line1Measures, [tab1, tab2, tab3, tab4], yPos);
  
  // Line 2: That saved a wretch like me
  const line2Measures = [
    {
      pickup: { syllable: 'That', position: tab1 - 12 },
      downbeat: { syllable: 'saved', chordNumber: '5' },
      additional: [{ syllable: 'a', offset: 15 }],
      passingChords: [{ number: '2', position: tab1 + 15 }]
    },
    {
      downbeat: { syllable: 'wretch', chordNumber: '6' },
      additional: [{ syllable: 'like', offset: 21 }],
      passingChords: [{ number: '3', position: tab2 + 21 }]
    },
    {
      downbeat: { syllable: 'me', chordNumber: '4' }
    },
    {
      downbeat: { syllable: '', chordNumber: '1' } // Rest measure
    }
  ];
  
  yPos = generateMeasureLine(doc, line2Measures, [tab1, tab2, tab3, tab4], yPos);
  
  // Line 3: I once was lost, but now am found
  const line3Measures = [
    {
      pickup: { syllable: 'I', position: tab1 - 6 },
      downbeat: { syllable: 'once', chordNumber: '1' },
      additional: [{ syllable: 'was', offset: 15 }]
    },
    {
      downbeat: { syllable: 'lost,', chordNumber: '1' },
      additional: [{ syllable: 'but', offset: 15 }],
      passingChords: [{ number: '5', position: tab2 + 15 }]
    },
    {
      downbeat: { syllable: 'now', chordNumber: '4' },
      additional: [{ syllable: 'am', offset: 12 }]
    },
    {
      downbeat: { syllable: 'found', chordNumber: '1' }
    }
  ];
  
  yPos = generateMeasureLine(doc, line3Measures, [tab1, tab2, tab3, tab4], yPos);
  
  // Line 4: Was blind, but now I see
  const line4Measures = [
    {
      pickup: { syllable: 'Was', position: tab1 - 9 },
      downbeat: { syllable: 'blind,', chordNumber: '1' },
      additional: [{ syllable: 'but', offset: 18 }],
      passingChords: [{ number: '6', position: tab1 + 18 }]
    },
    {
      downbeat: { syllable: 'now', chordNumber: '5' },
      additional: [{ syllable: 'I', offset: 12 }]
    },
    {
      downbeat: { syllable: 'see', chordNumber: '1' }
    },
    {
      downbeat: { syllable: '', chordNumber: '1' } // Rest measure
    }
  ];
  
  yPos = generateMeasureLine(doc, line4Measures, [tab1, tab2, tab3, tab4], yPos);
  
  return yPos;
}

function generateMeasureLine(doc, measures, tabPositions, yPos) {
  // Draw syllables
  doc.setFontSize(11);
  doc.setFont('helvetica', 'normal');
  doc.setTextColor(0, 0, 0);
  
  for (let i = 0; i < Math.min(measures.length, 4); i++) {
    const measure = measures[i];
    const tabPos = tabPositions[i];
    
    // Draw pickup notes
    if (measure.pickup) {
      doc.text(measure.pickup.syllable, measure.pickup.position, yPos);
    }
    
    // Draw downbeat syllable
    if (measure.downbeat && measure.downbeat.syllable) {
      doc.text(measure.downbeat.syllable, tabPos, yPos);
    }
    
    // Draw additional syllables
    if (measure.additional) {
      for (const syllable of measure.additional) {
        doc.text(syllable.syllable, tabPos + syllable.offset, yPos);
      }
    }
  }
  
  yPos += 6;
  
  // Draw chord numbers with color coding
  doc.setFont('helvetica', 'bold');
  
  for (let i = 0; i < Math.min(measures.length, 4); i++) {
    const measure = measures[i];
    const tabPos = tabPositions[i];
    
    // RED downbeat chord numbers
    if (measure.downbeat && measure.downbeat.chordNumber) {
      doc.setTextColor(200, 0, 0); // RED for downbeats
      doc.text(measure.downbeat.chordNumber, tabPos, yPos);
    }
    
    // BLACK passing chord numbers (up to 8 per measure)
    if (measure.passingChords) {
      doc.setTextColor(0, 0, 0); // BLACK for passing chords
      for (const passingChord of measure.passingChords) {
        doc.text(passingChord.number, passingChord.position, yPos);
      }
    }
  }
  
  doc.setTextColor(0, 0, 0); // Reset color
  yPos += 15;
  
  return yPos;
}

// Generate the example PDF
async function createExample() {
  try {
    console.log('ðŸŽ¼ Generating Amazing Grace example PDF...');
    
    const pdfBuffer = generateExamplePDF('Amazing Grace', mockLyricsData, mockChordsData);
    
    // Save to file
    const outputPath = path.join(__dirname, 'example-amazing-grace-output.pdf');
    fs.writeFileSync(outputPath, pdfBuffer);
    
    console.log('âœ… Example PDF generated successfully!');
    console.log(`ðŸ“„ Saved to: ${outputPath}`);
    console.log('\nðŸŽµ Syllable-Separated with Downbeat Alignment:');
    console.log('- Title: AMAZING GRACE (left-justified)');
    console.log('- Metadata: Key: G | Tempo: 120 BPM | Meter: 4/4');
    console.log('- Syllables separated like "A - maz - ing"');
    console.log('- RED numbers for downbeats (1, 4, 7, 10...)');
    console.log('- BLACK numbers for other chord changes');
    console.log('- Chord numbers positioned directly under syllables');
    console.log('- Downbeats: A-, Grace, sweet, sound, saved, wretch, me, etc.');
    console.log('- Professional Nashville Number System layout');
    
  } catch (error) {
    console.error('âŒ Error generating example:', error);
  }
}

// Run the example
if (require.main === module) {
  createExample();
}

module.exports = { generateExamplePDF, createExample };