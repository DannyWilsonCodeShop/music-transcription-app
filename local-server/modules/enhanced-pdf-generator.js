// Enhanced PDF Generator - Local Implementation
// Generates perfect Nashville Number System PDFs locally

const { jsPDF } = require('jspdf');
const fs = require('fs-extra');
const path = require('path');

async function generateEnhancedPDFLocally(integratedData, jobId, progressCallback) {
  console.log('üìÑ Starting enhanced PDF generation locally...');
  
  try {
    progressCallback(0.2, 'Initializing PDF document...');
    await simulateDelay(200);
    
    const pdfData = integratedData.pdfReadyData;
    const doc = new jsPDF();
    
    // Header Section
    progressCallback(0.4, 'Generating header and metadata...');
    doc.setFontSize(18);
    doc.setFont('helvetica', 'bold');
    doc.text(pdfData.title || 'Amazing Grace', 20, 20);
    
    let yPos = 30;
    
    // Metadata line
    const metadataText = `Key: ${pdfData.key} | Tempo: ${pdfData.tempo} BPM | Meter: ${pdfData.timeSignature}`;
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text(metadataText, 20, yPos);
    yPos += 13;
    
    const pageHeight = doc.internal.pageSize.height;
    const marginBottom = 20;
    
    // Generate verses using enhanced data
    progressCallback(0.6, 'Generating enhanced measure-based layout...');
    await simulateDelay(300);
    
    if (pdfData.verseGroups && pdfData.verseGroups.length > 0) {
      for (const verseGroup of pdfData.verseGroups) {
        // Check if we need a new page
        if (yPos > pageHeight - marginBottom - 60) {
          doc.addPage();
          yPos = 20;
        }
        
        // Verse label
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text(verseGroup.name, 20, yPos);
        yPos += 8;
        
        // Generate measure lines for this verse
        for (const measureLine of verseGroup.lines) {
          // Check if we need a new page
          if (yPos > pageHeight - marginBottom - 30) {
            doc.addPage();
            yPos = 20;
          }
          
          yPos = generateEnhancedMeasureLine(doc, measureLine, yPos);
        }
        
        yPos += 15; // Space between verses
      }
    }
    
    progressCallback(0.8, 'Adding footer and finalizing...');
    await simulateDelay(200);
    
    // Footer
    doc.setFontSize(8);
    doc.setTextColor(128, 128, 128);
    const footerText = 'Generated by Cipher - Enhanced Nashville Number System (Local)';
    doc.text(footerText, 20, pageHeight - 10);
    
    // Save PDF locally
    progressCallback(0.9, 'Saving PDF file...');
    const pdfBuffer = Buffer.from(doc.output('arraybuffer'));
    const pdfPath = path.join(__dirname, '..', 'generated-pdfs', `${jobId}.pdf`);
    await fs.writeFile(pdfPath, pdfBuffer);
    
    progressCallback(1.0, 'Enhanced PDF generation complete');
    
    console.log(`‚úÖ Enhanced PDF generated locally: ${pdfPath}`);
    
    return {
      pdfPath: pdfPath,
      pdfUrl: `http://localhost:3001/pdfs/${jobId}.pdf`,
      qualityMetrics: integratedData.qualityMetrics,
      metadata: {
        generationType: 'enhanced_local',
        totalPages: 1,
        totalMeasures: pdfData.measureLines?.length || 0,
        totalSyllables: pdfData.totalSyllables || 0,
        totalChords: pdfData.totalChords || 0
      }
    };
    
  } catch (error) {
    console.error('‚ùå Enhanced PDF generation error:', error);
    throw new Error(`PDF generation failed: ${error.message}`);
  }
}

function generateEnhancedMeasureLine(doc, measureLine, yPos) {
  // Generate a line of 4 measures using enhanced data structure
  const columnPositions = [38, 73, 108, 143]; // Exact positions from spec
  
  // Draw syllables
  doc.setFontSize(11);
  doc.setFont('helvetica', 'normal');
  doc.setTextColor(0, 0, 0);
  
  for (let i = 0; i < Math.min(measureLine.measures.length, 4); i++) {
    const measure = measureLine.measures[i];
    const tabPos = columnPositions[i];
    
    // Draw pickup notes
    if (measure.pickup) {
      doc.text(measure.pickup.syllable, measure.pickup.position, yPos);
    }
    
    // Draw downbeat syllable
    if (measure.downbeat && measure.downbeat.syllable) {
      doc.text(measure.downbeat.syllable, tabPos, yPos);
    }
    
    // Draw additional syllables
    if (measure.additional) {
      for (const syllable of measure.additional) {
        doc.text(syllable.syllable, tabPos + syllable.offset, yPos);
      }
    }
  }
  
  yPos += 6;
  
  // Draw chord numbers with color coding
  doc.setFont('helvetica', 'bold');
  
  for (let i = 0; i < Math.min(measureLine.measures.length, 4); i++) {
    const measure = measureLine.measures[i];
    const tabPos = columnPositions[i];
    
    // RED downbeat chord numbers
    if (measure.downbeat && measure.downbeat.chordNumber) {
      doc.setTextColor(200, 0, 0); // RED for downbeats
      doc.text(measure.downbeat.chordNumber, tabPos, yPos);
    }
    
    // BLACK passing chord numbers
    if (measure.passingChords && measure.passingChords.length > 0) {
      doc.setTextColor(0, 0, 0); // BLACK for passing chords
      for (const passingChord of measure.passingChords) {
        doc.text(passingChord.number, passingChord.position, yPos);
      }
    }
  }
  
  doc.setTextColor(0, 0, 0); // Reset color
  yPos += 15;
  
  return yPos;
}

async function simulateDelay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

module.exports = { generateEnhancedPDFLocally };